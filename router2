#!/usr/bin/env bash
# Script: router2.sh
# Author: tobil
# Date: 2026-02-01
# License: MIT
# Description: Installation script for setting up router on Rocky Linux, reworked with grok
# Version: v8.1
# Variables
user=${SUDO_USER:-$(whoami)}
if [ "$user" == "root" ]; then user="tobirouter"; fi
group=$(groups | awk '{print $1}')
drive1="sda1"
drive2="nvme0n1p2"
UUID1=$(sudo blkid -s UUID -o value /dev/"$drive1")
UUID2=$(sudo blkid -s UUID -o value /dev/"$drive2")
WAN_IF="eno1"
LAN_ETH="enp7s0"
LAN_WLAN="wlan0"
LAN_IP="10.10.10.1/24"
DHCP_RANGE="10.10.10.50,10.10.10.250,12h"
SSID="bunga"
WPA_PASS="bungahart"
COUNTRY_CODE="DE"
# Logfile
logfile="/home/$user/logging/install.log"
logpath="/home/$user/logging/"
# Get timestamp
get_timestamp() {
  timestamp=$(date +"%Y-%m-%d_%H:%M:%S")
}
# Initialize logging
logging() {
  get_timestamp
  echo "$timestamp Log path: $logpath"
  echo "$timestamp Log file: $logfile"
  # Check/create logfile
  if [[ -f "$logfile" ]]; then
    get_timestamp
    echo "$timestamp Logfile exists" | tee -a "$logfile"
  else
    get_timestamp
    echo "$timestamp Creating logfile"
    mkdir -p "$logpath" || {
      echo "$timestamp Failed to create logpath"
      exit 1
    }
    touch "$logfile" || {
      echo "$timestamp Failed to create logfile"
      exit 2
    }
    echo "$timestamp Logfile created" | tee -a "$logfile"
  fi
}
log() {
  echo "$timestamp $*" | tee -a "$logfile"
}
# Error handling
handling() {
  local error="$1"
  get_timestamp
  case $error in
    0) log "Script completed successfully" ;;
    1)
      log "Directory error"
      exit 1
      ;;
    2)
      log "Logfile error"
      exit 2
      ;;
    3)
      log "Cannot deactivate services"
      exit 3
      ;;
    4)
      log "Cannot set up WLAN"
      exit 4
      ;;
    5)
      log "Cannot bridge WLAN"
      exit 5
      ;;
    6)
      log "Cannot set forwarding IP"
      exit 6
      ;;
    *)
      log "Unknown error: $error"
      exit "$error"
      ;;
  esac
}
deactivated() {
  log "Stopping services"
  log "Stop NetworkManager"
  sudo systemctl is-active --quiet NetworkManager && systemctl disable --now NetworkManager || true
  log "Stop iptables"
  sudo systemctl is-active --quiet iptables && systemctl stop iptables || true
  log "Stop dhcpcd"
  sudo systemctl is-active --quiet "dhcpcd@$WAN_IF" && systemctl stop "dhcpcd@$WAN_IF" || true
  log "Stop dnsmasq"
  sudo systemctl is-active --quiet dnsmasq && systemctl stop dnsmasq || true
  log "Stop hostapd"
  sudo systemctl is-active --quiet hostapd && systemctl stop hostapd || true
  log "Stop smb"
  sudo systemctl is-active --quiet smb && systemctl stop smb || true
  log "Stop nmb"
  sudo systemctl is-active --quiet nmb && systemctl stop nmb || true
  log "Stop ssh"
  sudo systemctl is-active --quiet sshd && systemctl stop sshd || true
}
activated() {
  log "starting networkcards"
  log "br0 to bridge"
  sudo ip link add br0 type bridge || true
  log "enp7s0 to master br0"
  sudo ip link set enp7s0 up
  sudo ip link set enp7s0 master br0
  log "wlan0 to master bro"
  sudo ip link set wlan0 up
  sudo iw dev wlan0 set 4addr on || true
  sudo ip link set wlan0 master br0
  log "starting bridge"
  sudo ip link set br0 up
  log "setting ip"
  sudo ip addr flush dev br0 || true
  sudo ip addr add 10.10.10.1/24 dev br0
  log "starting services"
  log "Disable NetworkManager"
  sudo systemctl disable --now NetworkManager || true
  log "Start iptables"
  sudo systemctl start iptables || true
  log "Start dhcpcd"
  sudo systemctl start "dhcpcd@$WAN_IF" || true
  log "Start dnsmasq"
  sudo systemctl start dnsmasq || true
  log "Start hostapd"
  sudo systemctl start hostapd || true
  log "Start smb"
  sudo systemctl start smb || true
  log "Start nmb"
  sudo systemctl start nmb || true
  log "Start ssh"
  sudo systemctl start sshd || true
}
installprog() {
  log "Installing packages"
  needed=(
    "fzf"
    "polkit"
    "samba"
    "python3"
    "python3-pip"
    "iw"
    "hostapd"
    "dnsmasq"
    "dhcpcd"
    "openssh"
    "less"
    "htop"
    "vim"
    "neovim"
  )
  log "installing with dnf, activating epel-release"
  sudo dnf install -yq epel-release
  for prog in "${needed[@]}"; do
    log "$prog will be installed"
    sudo dnf install -yq "$prog" || exit 3
  done
  log "updating the system"
  sudo dnf update -yq || exit 3
}
bashing() {
  log "Setting up bashrc"
  cat >>"/home/$user/.bashrc" <<'HERE'
# ~/.bashrc
#
# If not running interactively, don't do anything
[[ $- != *i* ]] && return
alias ls='ls --color=auto'
alias grep='grep --color=auto'
PS1='[\u@\h \W]\$ '
# ~/.bashrc
#
# If not running interactively, don't do anything
[[ $- != *i* ]] && return
PS1='[\u@\h \W]\$ '
#export GREP_COLORS='mt=1;35'
#export LS_COLORS="di=1;35:fi=0:ln=36"
alias grep='grep --color=auto'
alias ls='ls --color=auto'
alias sl='ls -lh --color=auto'
fuzzy() {
  local file
  file=$(find . -type f | fzf --preview 'cat {}' --height 80% --border)
  [[ -n "$file" ]] && nvim "$file"
}
greppy() {
  local file=$(find . -type f | fzf --preview "grep -i --color=always {q} {} | head -n 20" --bind "change:reload:find . -type f")
  [[ -n "$file" ]] && nvim "$file" +/{q}
}
trs() {
  for file in "$@"; do
    filename=$(basename "$file")
    mv "$file" /tmp/"$filename"
  done
}
bashing() {
  local data
  local path
  local file
  local oldpath
  oldpath=$(pwd)
  data="$1"
  [[ -z "$data" ]] && exit 91
  handling() {
    local error="$1"
    case $error in
      0) echo "completed successfully" ;;
      88) echo "can't change into directory" ;;
      89) echo "can't create file" ;;
      90) echo "can't make it executable" ;;
      91) echo "no filename" ;;
      *) echo "unknown error" ;;
    esac
  }
  trap 'handling $?' EXIT
  file=$(basename "$data")
  path=$(dirname "$data")
  if [[ -d "$path" ]]; then
    cd "$path" || exit 88
    [[ -f "$file" ]] && trs "$file"
    touch "$file" || exit 89
    chmod +x "$file" || exit 90
    ls -lh
  else
    mkdir -p "$path"
    cd "$path" || exit 88
    touch "$file" || exit 89
    chmod +x "$file" || exit 90
    ls -lh
  fi
  cat <<EOF >"$file"
#!/usr/bin/env bash
# Script: $file
# Author: $(whoami)
# Date: $(date +"%Y-%m-%d_%H:%M:%S")
# License: MIT
# Description: ....
EOF
  cat <<'EOF' >>"$file"
# Logfile
logfile="$user/logging/logfile.log"
logpath="$user/logging/"
# Get timestamp
get_timestamp() {
  timestamp=$(date +"%Y-%m-%d_%H:%M:%S")
}
# Initialize logging
logging() {
  get_timestamp
  echo "$timestamp Log path: $logpath" | tee -a "$logfile"
  echo "$timestamp Log file: $logfile" | tee -a "$logfile"
  # Check/create logfile
  if [[ -f "$logfile" ]]; then
    get_timestamp
    echo "$timestamp Logfile exists" | tee -a "$logfile"
  else
    get_timestamp
    echo "$timestamp Creating logfile" | tee -a "$logfile"
    mkdir -p "$logpath" || { echo "$timestamp Failed to create logpath" | tee -a "$logfile"; exit 1; }
    touch "$logfile" || { echo "$timestamp Failed to create logfile" | tee -a "$logfile"; exit 2; }
    echo "$timestamp Logfile created" | tee -a "$logfile"
  fi
}
# Error handling
handling() {
  local error="$1"
  get_timestamp
  case $error in
    0) echo "$timestamp Script completed successfully" | tee -a "$logfile";;
    1) echo "$timestamp Directory error" | tee -a "$logfile"; exit 1;;
    2) echo "$timestamp Logfile error" | tee -a "$logfile"; exit 2;;
    4) echo "$timestamp nvim not installed" | tee -a "$logfile"; exit 4;;
    *) echo "$timestamp Unknown error: $error" | tee -a "$logfile"; exit "$error";;
  esac
}
trap 'handling $?' EXIT
EOF
  cd "$oldpath" || exit 88
}
HERE
}
sshing(){
  log "Enabling SSH"
  sudo systemctl enable --now sshd
  }
forwarding() {
  ### IP Forwarding
  log "Enabling IP Forwarding"
  cat <<EOF >/etc/sysctl.d/99-ipforward.conf
net.ipv4.ip_forward=1
EOF
  sysctl --system || exit 6
}
setdhcp() {
  ### Limit dhcpcd to WAN
  log "Configuring dhcpcd"
  cat <<EOF >/etc/dhcpcd.conf
denyinterfaces br0
denyinterfaces $LAN_ETH
denyinterfaces $LAN_WLAN
EOF
}
bridging() {
  ### Bridge
  log "Configuring bridge"
  ip link show br0 &>/dev/null || ip link add br0 type bridge
  ip link set br0 up
  ip link set "$LAN_ETH" up
  ip link set "$LAN_ETH" master br0 || exit 6
  ip addr flush dev br0 || exit 6
  ip addr replace "$LAN_IP" dev br0
}
nat() {
  ### NAT + Forwarding (idempotent)
  log "Configuring iptables NAT & Forwarding"
  iptables -t nat -C POSTROUTING -o "$WAN_IF" -j MASQUERADE 2>/dev/null \
    || iptables -t nat -A POSTROUTING -o "$WAN_IF" -j MASQUERADE
  iptables -C FORWARD -i "$WAN_IF" -o br0 -m state --state RELATED,ESTABLISHED -j ACCEPT 2>/dev/null \
    || iptables -A FORWARD -i "$WAN_IF" -o br0 -m state --state RELATED,ESTABLISHED -j ACCEPT
  iptables -C FORWARD -i br0 -o "$WAN_IF" -j ACCEPT 2>/dev/null \
    || iptables -A FORWARD -i br0 -o "$WAN_IF" -j ACCEPT
  mkdir -p /etc/iptables
  iptables -P INPUT DROP
  iptables -A INPUT -i lo -j ACCEPT
  iptables -A INPUT -i br0 -p tcp --dport 22 -j ACCEPT
  iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
  iptables-save >/etc/iptables/iptables.rules
  systemctl enable --now iptables
}
wan() {
  ### WAN DHCP
  log "Bringing up WAN + DHCP"
  ip link set "$WAN_IF" up
  systemctl enable --now "dhcpcd@$WAN_IF"
}
dnsmasq() {
  ### dnsmasq
  log "Configuring dnsmasq"
  cat <<EOF >/etc/dnsmasq.conf
interface=br0
bind-interfaces
dhcp-range=$DHCP_RANGE
domain-needed
bogus-priv
log-dhcp
EOF
  systemctl enable --now dnsmasq
}
wlansetup() {
  ### WLAN unblock (not aggressive!)
  log "Unblocking WLAN"
  rfkill unblock wifi || exit 4
  ### WLAN + Bridge
  log "Activating & bridging WLAN"
  ip link set "$LAN_WLAN" up
  iw dev "$LAN_WLAN" set 4addr on || log "4addr nicht moeglich"
  ip link set "$LAN_WLAN" master br0 || exit 5
}
samba() {
  ### Samba-Shares (router1 + router2)
  sudo cat <<EOF >/etc/samba/smb.conf
[global]
workgroup = WORKGROUP
server string = Router Shares
security = user
map to guest = bad user
usershare allow guests = yes
[router1]
path = /router1
browseable = yes
writable = yes
guest ok = yes
read only = no
force user = $user
force group = $group
create mask = 0644
directory mask = 0775
[router2]
path = /router2
browseable = yes
writable = yes
guest ok = yes
read only = no
force user = $user
force group = $group
create mask = 0644
directory mask = 0775
EOF
log "Setting up XFS mounts"
  sudo mkdir -p /router1 /router2
  grep -q "$UUID1" /etc/fstab || echo "UUID=$UUID1 /router1 xfs defaults 0 2" | sudo tee -a /etc/fstab
  grep -q "$UUID2" /etc/fstab || echo "UUID=$UUID2 /router2 xfs defaults 0 2" | sudo tee -a /etc/fstab
  sudo systemctl daemon-reload
  sudo mount -a || { log "mount -a fehlgeschlagen â€“ siehe dmesg"; exit 1; }
  sudo chown -R "$user":"$group" /router1 /router2
  sudo chmod -R 775 /router1 /router2
  sudo systemctl enable --now smb nmb
}
hostapd() {
  ### hostapd
  log "Configuring hostapd"
  cat <<EOF >/etc/hostapd/hostapd.conf
interface=$LAN_WLAN
bridge=br0
driver=nl80211
ssid=$SSID
country_code=$COUNTRY_CODE
ieee80211d=1
hw_mode=g
channel=6
wmm_enabled=1
ieee80211n=1
ht_capab=[HT40+][SHORT-GI-20][SHORT-GI-40]
auth_algs=1
macaddr_acl=0
ignore_broadcast_ssid=0
wpa=2
wpa_passphrase=$WPA_PASS
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
rsn_pairwise=CCMP
wpa_disable_eapol_key_retries=1
EOF
  echo 'DAEMON_CONF="/etc/hostapd/hostapd.conf"' >/etc/conf.d/hostapd
}
setdrives() {
  ### systemd-Override for WLAN-Device
  log "Hostapd systemd override"
  mkdir -p /etc/systemd/system/hostapd.service.d
  cat <<EOF >/etc/systemd/system/hostapd.service.d/override.conf
[Unit]
BindsTo=sys-subsystem-net-devices-$LAN_WLAN.device
After=sys-subsystem-net-devices-$LAN_WLAN.device
EOF
  sudo chown -R "$user":"$group" /router1
  sudo chown -R "$user":"$group" /router2
  systemctl daemon-reload
  systemctl enable --now hostapd
}
cleanup() {
  log "Cleaning up"
  sudo dnf clean all
  sudo dnf autoremove
}
autostart() {
  log "Creating systemd Autostart Service"
  cat <<EOF >/etc/systemd/system/router.service
[Unit]
Description=Router Auto Setup Script
After=network-pre.target
Wants=network-pre.target
[Service]
Type=oneshot
RemainAfterExit=yes
ExecStart=/root/router2.sh
User=root
StandardOutput=journal+console
StandardError=journal+console
[Install]
WantedBy=multi-user.target
EOF
  log "Enabling router service"
  systemctl daemon-reload
  systemctl enable router.service
  log "Systemd service created and enabled"
}
trap 'handling $?' EXIT
logging
deactivated
activated
installprog
bashing
sshing
forwarding
setdhcp
bridging
nat
wan
dnsmasq
wlansetup
samba
hostapd
setdrives
autostart
cleanup
